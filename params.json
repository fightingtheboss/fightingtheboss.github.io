{"name":"Scaling Meteor","tagline":"My experiences scaling Pegleg (pegleg.it), a Meteor project, beyond a single instance","body":"### It's Good To Have Goals\r\nI had three main objectives when scaling Pegleg to multiple instances:\r\n\r\n1. Site handles the load and works correctly\r\n2. Simple deployment\r\n3. Low cost\r\n\r\nI used these three criteria to evaluate the suitability of each solution for my purposes. Because of a lack of tools and time, I didn't load test any of these scenarios scientifically, so the decision on criteria 1 was made anecdotally (suitable enough for a small side-project like Pegleg). I'll circle back to load testing near the end.\r\n\r\n### Back to the Future (aka TL;DR)\r\nGoing from zero to hero took a few iterations (and a lot of research and trial-and-error). I ended up with three different deployment strategies for scaling Meteor:\r\n\r\n1. Manual deployment to AWS\r\n2. AWS Elastic Beanstalk deployment\r\n3. Custom deployment on private VPS\r\n\r\nAfter running on the manual AWS setup for a month, I ultimately ended up going with the private VPS option for simplicity and cost reasons that I'll get into below.\r\n\r\n### Understanding The Problem\r\nThe free hosting provided by Meteor at meteor.com is great for deploying prototypes and toys but if your traffic starts to ramp up, you'll eventually have to move on to your own infrastructure. Given that deploying to meteor.com is basically a black box, there's some background information you need to deploy a Meteor app to your own stack:\r\n\r\n#### Node\r\nAs of Meteor 0.6.3.1, the current compatible version of node is **0.8.x**, so this is what you'll need to install on your server(s).\r\n* The Meteor team is working on making Meteor compatible with the 0.10.x version of Node. There's a mention [here](https://github.com/meteor/meteor/issues/859) and you can take a look at the code on the [node-0.10 branch](https://github.com/meteor/meteor/tree/node-0.10).\r\n* [Chris Lea maintains a legacy PPA](https://launchpad.net/~chris-lea/+archive/node.js-legacy) for installing the 0.8.x version of Node using apt-get\r\n\r\n#### MongoDB\r\n##### Backing up your data\r\nYou'll need to back up the data from the DB on your meteor.com site\r\n* Oli Evans made a dead simple bash script to help you called [Meteor Dump](https://gist.github.com/olizilla/5209369)\r\n\r\n##### Hosting your data\r\nMeteor uses [MongoHQ](http://www.mongohq.com) and unless you have some special reason to run your own MongoDB server, I highly recommend doing the same. The sandbox account gives you 512MB of storage for free and the prices are reasonable beyond that.\r\n* It's super simple to [copy your data directly across to your new MongoHQ database](https://groups.google.com/d/msg/meteor-talk/KvDWrqZpy-w/5-xrKOjHVFkJ) once you've created an account\r\n\r\n#### Meteor (and Meteorite)\r\n##### Bundling your app\r\nYou'll need to bundle your app either before or during deploy using `meteor bundle` (or `mrt bundle`)\r\n* This creates a node-friendly bundle that you can run with node directly (i.e. `node bundle/main.js`)\r\n* If you create your bundle locally and then upload to your server, you'll have to be careful to rebuild your node dependencies in the server environment, [as noted in the Meteor docs in the red text under *Running your own infrastructure*](http://docs.meteor.com/#deploying)\r\n\r\n##### Packages\r\nIf you add packages using Meteorite locally then you'll want Meteorite on the server as well\r\n* This is bound to change pretty soon as Meteor (as of 0.6.0) now handles its own versioning and codifies package management a bit more and [Meteorite is soon to change to catch up](https://groups.google.com/forum/?fromgroups#!topic/meteor-talk/1RwTlcH0Wzg).\r\n\r\n##### Environment Variables\r\nMeteor expects certain environment variables are set when the app is started:      \r\n\r\n`MONGO_URL`      \r\nThe URL to your MongoDB instance using the mongodb:// protocol.\r\n\r\n`ROOT_URL`     \r\nIf you serve your site from a domain other than localhost, you'll need to set this so that URLs within your app point to the right place ([Meteor.absoluteUrl](http://docs.meteor.com/#meteor_absoluteurl) depends on this variable being set).\r\n\r\n`PORT`     \r\nThe port the app server should run on. This will vary depending on your environment and setup as we'll discuss below.\r\n\r\nOther packages may require specific environment variables (e.g. MAIL_URL).\r\n\r\n#### Load Balancing & Session Affinity\r\nWhen you're running more than one instance of your app, you'll need to spread the requests across them using a load balancer.\r\n\r\n* Because of the way Meteor works, you'll need a load balancer that supports \"session affinity\" or \"sticky sessions\". [Read Matt DeBergalis' succinct explanation.](http://stackoverflow.com/a/13716069/2202261)\r\n* A secondary problem related to load balancing is that there will be a delay when updating clients connected to instances other than the one where writes were made (this is explained by Matt DeBergalis in the above link as well). [Meteor Cluster](https://github.com/arunoda/meteor-cluster) is an elegant workaround using Redis if that is a deal-breaker for your app. In the longer term, [this will be addressed in future versions of Meteor](https://trello.com/card/multitier-server-architecture-support-very-large-numbers-of-simultaneous-clients/508721606e02bb9d570016ae/46).\r\n\r\nSome of the above is covered in the Meteor docs under [\"Running on your own infrastructure\"](http://docs.meteor.com/#deploying), which is a good thing to read before continuing.\r\n\r\n### Manual Deploy to AWS\r\nStarted off with [Meteor.sh](https://github.com/netmute/meteor.sh) and modified it to handle multiple instances. This requires installing the AWS API Tools (no small feat given their lacklustre documentation).\r\n\r\nTODO: Fork the Meteor.sh repo, make the changes and add documentation about AWS tools, add link here\r\n\r\nSince the bash script ran the deploy in sequence rather than in parallel, it quickly became unacceptably long to deploy to many instances. I needed a parallelized and easily customizable deploy process so I turned to the tool I have the most experience with: Capistrano.\r\n\r\nCapistrano is a Ruby-based deploy tool that is generally used with Rails. It parallelizes deploys to multiple servers and gives you complex control over how the deploy is performed and what you can do both locally and on the server.\r\n\r\nTODO: Add gist of the deploy script for AWS\r\n\r\n### AWS Elastic Beanstalk Deployment\r\n[EB Configuration File](https://gist.github.com/fightingtheboss/5432059)\r\n\r\n\r\n### Custom Deployment on Private VPS\r\nTODO: Discuss topography (HAProxy -> nginx -> node)\r\nTODO: Add gist of the deploy script for AWS\r\n\r\n\r\n## Background\r\n### Beginnings\r\nI built [Pegleg](http://pegleg.it) back in January as a side-project to learn Meteor and to help friends and film-buffs find full-length movies on YouTube by working together. Initially I was using the generously provided and dead simple free meteor.com hosting, which is the perfect platform for getting your Meteor prototypes some real-world users on the web. With a few blog posts about it and word of mouth, it slowly gained a bit of popularity.\r\n\r\n### Blow-Up\r\nAfter being up and slowly improved for about six or eight weeks, the link to Pegleg was posted on Hacker News on a Friday morning and made it to the home page. After an initial bout of euphoria about having hit on the holy grail of an HN home page mention, I was quickly hit with the reality of what that means. The free hosting provided by Meteor wasn't designed to handle that kind of load and the site slowed to an unusable crawl.\r\n\r\n### Short-Circuit\r\nAfter trying to resolve things with the gracious and patient help of Kara and David at Meteor one thing became certain: I needed to scale off of the Meteor free hosting to meet the needs of the new influx of users. This was easier said than done because there wasn't much in the way of documentation on that front. David pointed me to [this blog post about load balancing on AWS](http://www.ripariandata.com/blog/creating-an-aws-elastic-load-balancer) to get me started and that's where we'll begin this journey.\r\n\r\n### Batteries Not Included\r\nAs a caveat, I'm certainly not a sys-ops master, and I often find jockeying servers and worrying about deployments to be a tedious necessary evil to get my sites online. This situation forced me to learn a bunch of the stuff I'd been wilfully ignoring for as long as I could. If you are great at this stuff I'd love to hear feedback on better ways to approach this.","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}